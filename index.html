// Calculate dPPM for each month
if (mrrDataLoaded && mrrData.length > 0) {
    console.log('=== MONTHLY dPPM CALCULATION ===');
    
    // Group MRR data by month
    const mrrMonthlyStats = {};
    
    // Get vendor codes for current supplier filter
    const supplierFilter = document.getElementById('supplierFilter').value;
    let relevantVendorCodes = [];
    
    if (supplierFilter !== 'all') {
        // Get vendor codes for the selected supplier
        relevantVendorCodes = [...new Set(
            filteredData
                .filter(row => row.supplier === supplierFilter)
                .map(row => row.vendorCode)
                .filter(v => v)
        )];
        console.log('Supplier:', supplierFilter, 'Vendor Codes:', relevantVendorCodes);
    }
    
    // Filter and group MRR data
    let mrrDataToProcess = mrrData;
    
    // Filter by vendor code if specific supplier selected
    if (supplierFilter !== 'all' && relevantVendorCodes.length > 0) {
        mrrDataToProcess = mrrData.filter(row => relevantVendorCodes.includes(row.entity));
        console.log('Filtered MRR records:', mrrDataToProcess.length);
    }
    
    // Group MRR by month
    mrrDataToProcess.forEach(row => {
        if (row.closeDate) {
            const monthKey = `${row.closeDate.getFullYear()}-${String(row.closeDate.getMonth() + 1).padStart(2, '0')}`;
            
            if (!mrrMonthlyStats[monthKey]) {
                mrrMonthlyStats[monthKey] = { totalRejected: 0 };
            }
            
            const rejected = parseFloat(row.qtyRejected) || 0;
            mrrMonthlyStats[monthKey].totalRejected += rejected;
        }
    });
    
    console.log('MRR Monthly Stats:', mrrMonthlyStats);
    
    // Calculate monthly received quantities and dPPM
    Object.keys(monthlyStats).forEach(monthKey => {
        const stats = monthlyStats[monthKey];
        
        // Get all PO data for this month (already filtered by supplier in filteredData)
        const monthData = filteredData.filter(row => {
            if (!row.receiptDate) return false;
            const rowMonthKey = `${row.receiptDate.getFullYear()}-${String(row.receiptDate.getMonth() + 1).padStart(2, '0')}`;
            return rowMonthKey === monthKey;
        });
        
        // Calculate total QUANTITY received for this month (sum of received qty, not count of lines!)
        stats.totalReceived = monthData.reduce((sum, row) => {
            const received = parseFloat(row.received) || 0;
            return sum + received;
        }, 0);
        
        // Get rejected QUANTITY for this month
        stats.totalRejected = mrrMonthlyStats[monthKey] ? mrrMonthlyStats[monthKey].totalRejected : 0;
        
        // Calculate dPPM
        if (stats.totalReceived > 0) {
            stats.dppm = (stats.totalRejected / stats.totalReceived) * 1000000;
        } else {
            stats.dppm = null;
        }
        
        console.log(`Month ${monthKey}:`, {
            lines: stats.total,
            receivedQty: stats.totalReceived,
            rejectedQty: stats.totalRejected,
            dppm: stats.dppm ? stats.dppm.toFixed(0) : 'N/A'
        });
    });
    
    console.log('=== END MONTHLY dPPM ===');
}
